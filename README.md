# pcf-usage-report-generator

Scripts to generate PCF usage reports for AIs, SIs and Tasks, inspired by this great [cf-tools](https://github.com/rakutentech/cf-tools).

There are three types of usage reports:
- Application Instance (AI)
- Service Instance (SI)
- Task

> Disclaimer: 
> The scripts here are purely for learning purposes on how to interact with PCF's accounting [APIs](http://docs.pivotal.io/pivotalcf/2-0/opsguide/accounting-report.html). They're still under development and may be buggy at the moment. All accounting results generated here are just for reference ONLY and the actual accounting results shall follow what accounting reports are generated by PCF's Apps Manager.


# Prerequisites

- [jq](https://stedolan.github.io/jq/download/) >=1.5 installed
- [cf](https://github.com/cloudfoundry/cli/releases) command line tool installed
- Logged into PCF by `cf login`

> Note: if you want to generate usage reports for all orgs, login with admin account instead


# Generate Usage Reports

Given below inputs: 
1) the sys domain of PCF: sys.pcf.mycompany.com
2) the starting from date (YYYY-mm-dd) to calculate: 2018-01-12

So we export them as below:
```sh
$ export SYS_DOMAIN=sys.pcf.mycompany.com
$ export USAGE_START_DATE="2018-01-01"
$ export ORG="dev"  #org is optional to set; default would be all orgs -- which may take pretty long time
```


## Application Instances (AI): `pcf-usage-report-ai.sh`

This is used to generate detailed AI usage reports in one single cli call.

Below are some common usage examples.

1. Take a look at the usage first:

```sh
./pcf-usage-report-ai.sh -h
Usage: pcf-usage-report-ai.sh [OPTION]...

  -D <sys domain name>      PCF's system domain name, e.g. sys.pcf-gcp.abc.com
  -s <sort field>           sort by specified field index or its name
  -S <sort field>           sort by specified field index or its name (numeric)
  -f <field1,field2,...>    show only fields specified by indexes or field names
  -c <minutes>              filter objects created within last <minutes>
  -u <minutes>              filter objects updated within last <minutes>
  -C <minutes>              filter objects created more than <minutes> ago
  -U <minutes>              filter objects updated more than <minutes> ago
  -k <minutes>              update cache if older than <minutes> (default: 10)
  -n                        ignore cache
  -N                        do not format output and keep it tab-separated (useful for further processing)
  -j                        print json (filter and sort options are not applied when -j is in use)
  -v                        verbose
  -o <org1,org2...>         a list of orgs to be used for usage generation, separated by commas
  -d                        usage calculation starting date, YYYY-MM-DD
  -h                        display this help and exit
```

2. To generate AI usage report with specified ORG (e.g. dev here) and desired fields only, in "browsing" mode:

```sh
$ ./pcf-usage-report-ai.sh -D ${SYS_DOMAIN} -d ${USAGE_START_DATE} -o ${ORG} \
    -f year,month,org_name,app_name,instance_count,memory_in_mb_per_instance,duration_in_seconds
```

Which will output something like:

```
year  month  org_name  app_name  instance_count  memory_in_mb_per_instance  duration_in_seconds
2018  01     dev       my-app-1       1               1024                       1724051
2018  01     dev       my-app-2       1               1024                       182900
2018  01     dev       my-app-3       1               512                        2005
2018  01     dev       my-app-4       1               768                        1854941
2018  01     dev       my-app-5       2               2048                       2678400
2018  02     dev       my-app-1       1               1024                       139019
2018  02     dev       my-app-2       1               1024                       2270219
2018  02     dev       my-app-3       1               1024                       2419200
2018  02     dev       my-app-4       1               1024                       58570
2018  02     dev       my-app-5       1               512                        16
2018  02     dev       my-app-6       1               768                        2419200
2018  02     dev       my-app-7       2               2048                       2270145
2018  03     dev       my-app-1       1               1024                       2573355
2018  03     dev       my-app-2       1               768                        2678400
2018  03     dev       my-app-3       2               1024                       178
2018  03     dev       my-app-4       2               1024                       3358
2018  04     dev       my-app-1       1               1024                       1169317
2018  04     dev       my-app-2       1               1024                       1421288
2018  04     dev       my-app-3       1               1024                       2510
2018  04     dev       my-app-4       1               1024                       318
2018  04     dev       my-app-8       1               1024                       4596
2018  04     dev       my-app-9       1               1024                       508266
2018  04     dev       my-app-x       2               1024                       337864
:
```

> Tips: 
> - If the records are more than one screen, please hit ENTER to browse the rest; Key in "q" to exit
> - The complete field list includes: year month org_guid org_name instance_count memory_in_mb_per_instance duration_in_seconds space_guid space_name app_guid app_name


3. To generate AI usage report with specified ORG (e.g. dev here) and desired fields only, with a delimiter (`csv` or `tsv`) separated format which will be easier for further processing:

```sh
$ ./pcf-usage-report-ai.sh -D ${SYS_DOMAIN} -d ${USAGE_START_DATE} -o ${ORG} \
    -f year,month,org_name,instance_count,memory_in_mb_per_instance,duration_in_seconds -N -F csv > ai-dev.csv
```

> Tips: Refer to below [Process Usage Reports](#process-usage-reports) for how to establish better usage analysis reports


## Service Instances (SI): `pcf-usage-report-si.sh`

Similarly, this is used to generate detailed SI usage reports in one single cli call.

Below are some common usage examples.

1. Take a look at the usage first:

```sh
./pcf-usage-report-si.sh -h
Usage: pcf-usage-report-si.sh [OPTION]...

  -D <sys domain name>      PCF's system domain name, e.g. sys.pcf-gcp.abc.com
  -s <sort field>           sort by specified field index or its name
  -S <sort field>           sort by specified field index or its name (numeric)
  -f <field1,field2,...>    show only fields specified by indexes or field names
  -c <minutes>              filter objects created within last <minutes>
  -u <minutes>              filter objects updated within last <minutes>
  -C <minutes>              filter objects created more than <minutes> ago
  -U <minutes>              filter objects updated more than <minutes> ago
  -k <minutes>              update cache if older than <minutes> (default: 10)
  -n                        ignore cache
  -N                        do not format output and keep it tab-separated (useful for further processing)
  -j                        print json (filter and sort options are not applied when -j is in use)
  -v                        verbose
  -o <org1,org2...>         a list of orgs to be used for usage generation, separated by commas
  -d                        usage calculation starting date, YYYY-MM-DD
  -h                        display this help and exit
```

2. To generate SI usage report with specified ORG (e.g. dev here) and desired fields only, in "browsing" mode:

```sh
$ ./pcf-usage-report-si.sh -D ${SYS_DOMAIN} -d ${USAGE_START_DATE} -o ${ORG} \
    -f year,month,org_name,instance_count,memory_in_mb_per_instance,duration_in_seconds
```

Which will output something like:

```
year  month  org_name  duration_in_seconds
2018  01     dev       2678400
2018  01     dev       2678400
2018  01     dev       2948
2018  01     dev       3815
2018  02     dev       12
2018  02     dev       2262296
2018  02     dev       2295350
2018  02     dev       2295350
2018  02     dev       2419200
2018  03     dev       2678400
2018  03     dev       2678400
2018  04     dev       1762687
2018  04     dev       2592000
2018  04     dev       2592000
2018  04     dev       2592000
2018  04     dev       337676
:
```

> Tips: 
> - If the records are more than one screen, please hit ENTER to browse the rest; Key in "q" to exit;
> - The complete field list includes: year month org_guid org_name duration_in_seconds space_guid space_name service_instance_guid service_instance_name service_guid service_name service_plan_guid service_plan_name service_instance_creation deleted service_instance_deletion


3. To generate SI usage report with specified ORG (e.g. dev here) and desired fields only, with a delimiter (`csv` or `tsv`) separated format which will be easier for further processing:

```sh
$ ./pcf-usage-report-si.sh -D ${SYS_DOMAIN} -d ${USAGE_START_DATE} -o ${ORG} -f year,month,org_name,instance_count,memory_in_mb_per_instance,duration_in_seconds -N -F csv > si-dev.csv
```

> Tips: Refer to below [Process Usage Reports](#process-usage-reports) for how to establish better usage analysis reports


## Tasks: `pcf-usage-report-task.sh`

Similarly, this is used to generate detailed Task usage reports in one single cli call.

Below are some common usage examples.

1. Take a look at the usage first:

```sh
./pcf-usage-report-task.sh -h
Usage: pcf-usage-report-task.sh [OPTION]...

  -D <sys domain name>      PCF's system domain name, e.g. sys.pcf-gcp.abc.com
  -s <sort field>           sort by specified field index or its name
  -S <sort field>           sort by specified field index or its name (numeric)
  -f <field1,field2,...>    show only fields specified by indexes or field names
  -c <minutes>              filter objects created within last <minutes>
  -u <minutes>              filter objects updated within last <minutes>
  -C <minutes>              filter objects created more than <minutes> ago
  -U <minutes>              filter objects updated more than <minutes> ago
  -k <minutes>              update cache if older than <minutes> (default: 10)
  -n                        ignore cache
  -N                        do not format output and keep it tab-separated (useful for further processing)
  -j                        print json (filter and sort options are not applied when -j is in use)
  -v                        verbose
  -h                        display this help and exit
  -o <org,org...>           a list of orgs to be used for usage generation, separated by commas
  -d                        usage calculation starting date, YYYY-MM-DD
```

2. To generate Task usage report with specified ORG (e.g. dev here) and desired fields only, in "browsing" mode:

```sh
$ ./pcf-usage-report-task.sh -D ${SYS_DOMAIN} -d ${USAGE_START_DATE} -o ${ORG} \
    -f year,month,org_name,app_name,task_count,total_duration_in_seconds,memory_in_mb_per_instance
```

Which will output something like:

```
year  month  org_name  app_name  task_count  total_duration_in_seconds  memory_in_mb_per_instance
2018  05     dev       lattice   1           2                          1024
```

> Tips:
> - If the records are more than one screen, please hit ENTER to browse the rest; Key in "q" to exit;
> - Typically, there are just few task records, depending on how the company uses PCF;
> - The complete field list includes: year month org_guid org_name task_count total_duration_in_seconds memory_in_mb_per_instance app_guid app_name


3. To generate Task usage report with specified ORG (e.g. dev here) and desired fields only, with a delimiter (csv or tsv) separated format which will be easier for further processing:

```sh
$ ./pcf-usage-report-task.sh -D ${SYS_DOMAIN} -d ${USAGE_START_DATE} -o ${ORG} \
    -f year,month,org_name,app_name,task_count,total_duration_in_seconds,memory_in_mb_per_instance -N -F csv > task-dev.csv
```

> Tips: Refer to below [Process Usage Reports](#process-usage-reports) for how to establish better usage analysis reports


# Process Usage Reports

Let's use Excel as example to establish better usage analysis reports
The steps are exactly the same for all types of usage reports, as below:
-> Open Excel
-> Click File
-> Click Import
-> Choose default "CSV file" and click Import
-> Browse and choose the file generated, click "Get Data"
-> In the "Text Import Wizard" step 1 of 3, make sure "Delimited" is selected, click Next
-> In the "Text Import Wizard" step 2 of 3, make sure "Tab" is selected as the delimitter, click Next
-> In the "Text Import Wizard" step 2 of 3, click Finish
-> In the "Import Data" promt, choose "New sheet" to place our imported data


## AI Reports

Add two more necessary fields: instance_hours and memory_hours.

The formula for these two fields:
- instance_hours  = instance_count * (duration_in_seconds / 3600)
- memory_hours    = instance_count * (memory_in_mb_per_instance / 1024) * (duration_in_seconds / 3600)

> Tips:
> - You may add a Pivot table for better analysis
> - Please refer to the sample spreadsheet [ai-analysis.xlsx](analysis/ai-analysis.xlsx) for details


## SI Reports

Add one more necessary field: service_instance_hours.

The formula for this field:
- service_instance_hours  = duration_in_seconds / 3600

> Tips:
> - You may add a Pivot table for better analysis
> - Please refer to sample spreadsheet [si-analysis.xlsx](analysis/si-analysis.xlsx) for details


## Task Reports

Tasks are similar to Apps, one may add two more necessary fields: instance_hours and memory_hours.

The formula for these two fields:
- instance_hours  = instance_count * (duration_in_seconds / 3600)
- memory_hours    = instance_count * (memory_in_mb_per_instance / 1024) * (duration_in_seconds / 3600)

> Tips:
> - You may add a Pivot table for better analysis
> - Please refer to the sample spreadsheet [task-analysis.xlsx](analysis/task-analysis.xlsx) for details


# Change Logs:

- 13/05/2018: initial draft
- 15/07/2018: added `-F <csv,tsv>` support to generate `csv` or `tsv` formatted output


# References

- Reporting App, Task, and Service Instance Usage
  http://docs.pivotal.io/pivotalcf/2-0/opsguide/accounting-report.html#cf-cli


# Known Issues

## `jq` Errors

If you encountered errors like:
```sh
jq: error (at <stdin>:1): Cannot index number with string "xxx"
```
Or
```sh
jq: error (at <stdin>:180): Cannot iterate over null (null)
```

It's probably caused by no records found or `cf` token expiry.
Please check whether you're using corret inputs like org name, or simply re-login by using `cf login`.

Will improve the scripts' robustness in future.